# üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Haiku Explainer ‚Äî –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑

**–î–∞—Ç–∞:** 2026-01-28  
**–°—Ç–∞—Ç—É—Å:** ‚ùå –ù–ï –†–ê–ë–û–¢–ê–ï–¢ ‚Äî –ù–∞–π–¥–µ–Ω—ã 3 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏

### ‚úÖ 1. Haiku Explainer ‚Äî –ú–æ–¥—É–ª—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
```bash
‚úÖ Haiku module imported
‚úÖ Haiku enabled: True
‚úÖ API key exists: True
‚úÖ API key length: 73 chars
```

**–í—ã–≤–æ–¥:** –ú–æ–¥—É–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, API –∫–ª—é—á –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –¥–ª–∏–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞.

---

### ‚ùå 2. Smart Notifications ‚Äî –í–´–ö–õ–Æ–ß–ï–ù–´
```bash
‚úÖ Smart notifications module imported
‚ùå Smart notifications enabled: False
```

**–í—ã–≤–æ–¥:** –ú–æ–¥—É–ª—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å `enabled=False` –∏ –≤–∫–ª—é—á–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `start()`.

---

### ‚úÖ 3. OpenRouter API key ‚Äî –ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
```bash
OPENROUTER_API_KEY=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
```

**–í—ã–≤–æ–¥:** API –∫–ª—é—á OpenRouter –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ `.env` –∏ –≤—ã–≥–ª—è–¥–∏—Ç –≤–∞–ª–∏–¥–Ω–æ.

---

### ‚ùå 4. –õ–æ–≥–∏ ‚Äî –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –º–æ–¥–µ–ª–∏
```bash
[ERROR] app.intelligence.haiku_explainer:_call_api:269
Haiku API error: 400 - {
  "error": {
    "message": "anthropic/claude-3-haiku-20240307 is not a valid model ID",
    "code": 400
  },
  "user_id": "user_37mhObK2Qu34gsodsL3PG95TEdE"
}
```

**–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏:**
- 01:06:40 ‚Äî Haiku API error 400
- 01:08:10 ‚Äî Haiku API error 400
- 01:09:41 ‚Äî Haiku API error 400
- 01:11:11 ‚Äî Haiku API error 400

**–í—ã–≤–æ–¥:** OpenRouter API **–æ—Ç–∫–ª–æ–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã** –∏–∑-–∑–∞ –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ ID –º–æ–¥–µ–ª–∏.

---

## üî¥ –ü–†–û–ë–õ–ï–ú–ê #1: –ù–µ–≤–∞–ª–∏–¥–Ω—ã–π ID –º–æ–¥–µ–ª–∏ (–ö–†–ò–¢–ò–ß–ù–û)

### –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
**–§–∞–π–ª:** `app/intelligence/haiku_explainer.py`, —Å—Ç—Ä–æ–∫–∞ 34

```python
MODEL = "anthropic/claude-3-haiku-20240307"  # ‚ùå –°—Ç–∞—Ä—ã–π ID —Å –¥–∞—Ç–æ–π
```

### –ü–æ—á–µ–º—É –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç?
OpenRouter **–±–æ–ª—å—à–µ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç** —Å—Ç–∞—Ä—ã–µ ID –º–æ–¥–µ–ª–∏ —Å –¥–∞—Ç–∞–º–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏.

### –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏ –≤ OpenRouter (2026-01-28):

| ID –º–æ–¥–µ–ª–∏ | –ù–∞–∑–≤–∞–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|-----------|----------|--------|
| `anthropic/claude-haiku-4.5` | Claude Haiku 4.5 | ‚úÖ –ù–æ–≤–µ–π—à–∞—è |
| `anthropic/claude-3.5-haiku` | Claude 3.5 Haiku | ‚úÖ –ê–∫—Ç—É–∞–ª—å–Ω–∞—è |
| `anthropic/claude-3-haiku` | Claude 3 Haiku | ‚úÖ –°—Ç–∞—Ä–∞—è (—Ä–∞–±–æ—Ç–∞–µ—Ç) |
| `anthropic/claude-3-haiku-20240307` | - | ‚ùå **–ù–ï –†–ê–ë–û–¢–ê–ï–¢** |

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
```python
# –í–∞—Ä–∏–∞–Ω—Ç 1: –°–∞–º–∞—è –¥–µ—à—ë–≤–∞—è –∏ –±—ã—Å—Ç—Ä–∞—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
MODEL = "anthropic/claude-3.5-haiku"

# –í–∞—Ä–∏–∞–Ω—Ç 2: –ù–æ–≤–µ–π—à–∞—è –≤–µ—Ä—Å–∏—è (–¥–æ—Ä–æ–∂–µ)
MODEL = "anthropic/claude-haiku-4.5"

# –í–∞—Ä–∏–∞–Ω—Ç 3: –°—Ç–∞—Ä–∞—è, –Ω–æ —Å—Ç–∞–±–∏–ª—å–Ω–∞—è
MODEL = "anthropic/claude-3-haiku"
```

### –¶–µ–Ω—ã (OpenRouter, 2026):
```
claude-3.5-haiku:   $0.25 / 1M input,  $1.25 / 1M output
claude-haiku-4.5:   $0.50 / 1M input,  $2.50 / 1M output
claude-3-haiku:     $0.25 / 1M input,  $1.25 / 1M output
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `anthropic/claude-3.5-haiku` (–±–∞–ª–∞–Ω—Å —Ü–µ–Ω–∞/–∫–∞—á–µ—Å—Ç–≤–æ).

---

## üü° –ü–†–û–ë–õ–ï–ú–ê #2: Smart Notifications –≤—ã–∫–ª—é—á–µ–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

### –¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
**–§–∞–π–ª:** `app/core/smart_notifications.py`, —Å—Ç—Ä–æ–∫–∞ 145

```python
def __init__(self):
    self.enabled = False  # ‚ùå –í—ã–∫–ª—é—á–µ–Ω–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    ...
```

### –ö–æ–≥–¥–∞ –≤–∫–ª—é—á–∞–µ—Ç—Å—è?
**–§–∞–π–ª:** `app/notifications/telegram_bot.py`, —Å—Ç—Ä–æ–∫–∞ 1052

```python
# –ó–∞–ø—É—Å–∫–∞–µ–º smart notifications
await smart_notifications.start()  # –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞ –∏–∑ WebApp
```

**–°—Ç—Ä–æ–∫–∞ 172 –≤ `smart_notifications.py`:**
```python
async def start(self):
    self.enabled = True  # ‚úÖ –í–∫–ª—é—á–∞–µ—Ç—Å—è –∑–¥–µ—Å—å
    ...
```

### –ü—Ä–æ–±–ª–µ–º–∞:
Smart Notifications –≤–∫–ª—é—á–∞—é—Ç—Å—è **–¢–û–õ–¨–ö–û** –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ –∏–∑ WebApp —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É `/start` –∏–ª–∏ `/app`.

–ï—Å–ª–∏ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω —á–µ—Ä–µ–∑:
- `python -m app.main` (–≥–ª–∞–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å)
- Supervisor/systemd
- –ë–µ–∑ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å WebApp

–¢–æ `smart_notifications.start()` **–ù–ò–ö–û–ì–î–ê –ù–ï –í–´–ó–´–í–ê–ï–¢–°–Ø**, –∏ —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Å—Ç–∞—ë—Ç—Å—è –≤—ã–∫–ª—é—á–µ–Ω–Ω–æ–π.

### –°–ª–µ–¥—Å—Ç–≤–∏–µ:
```python
# app/core/smart_notifications.py, —Å—Ç—Ä–æ–∫–∞ 612
if not self.enabled:
    return  # –ù–µ –±—É–¥–µ—Ç AI –æ–±—ä—è—Å–Ω–µ–Ω–∏–π
```

Haiku Explainer **–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑ Smart Notifications**, –ø–æ—ç—Ç–æ–º—É –¥–∞–∂–µ –µ—Å–ª–∏ –∏—Å–ø—Ä–∞–≤–∏—Ç—å ID –º–æ–¥–µ–ª–∏, –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –Ω–µ –±—É–¥—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è, –ø–æ–∫–∞ `enabled=False`.

---

## üü¢ –ü–†–û–ë–õ–ï–ú–ê #3: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å (minor, –Ω–æ –≤–∞–∂–Ω–æ)

### –°–∏–≥–Ω–∞—Ç—É—Ä–∞ —Ñ—É–Ω–∫—Ü–∏–∏
**–§–∞–π–ª:** `app/intelligence/haiku_explainer.py`, —Å—Ç—Ä–æ–∫–∞ 148

```python
async def explain(self, request: ExplainRequest) -> Optional[str]:
    """–ü–æ–ª—É—á–∏—Ç—å AI –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ"""
    ...
```

–≠—Ç–æ **async** —Ñ—É–Ω–∫—Ü–∏—è, —Ç—Ä–µ–±—É–µ—Ç `await`.

### –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
**–§–∞–π–ª:** `app/core/smart_notifications.py`, —Å—Ç—Ä–æ–∫–∞ 612 (‚úÖ –ø—Ä–∞–≤–∏–ª—å–Ω–æ)

```python
explanation = await haiku_explainer.explain(
    ExplainRequest(type=ai_type, data=ai_data)
)
```

### –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å):
```python
# ‚ùå –ë–ï–ó await ‚Äî –≤–µ—Ä–Ω—ë—Ç coroutine, –∞ –Ω–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
explanation = haiku_explainer.explain(request)
```

**–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ:** –í –∫–æ–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å `await`.

---

## üóÇÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–∞–±–æ—Ç—ã Haiku Explainer

### Flow –¥–∏–∞–≥—Ä–∞–º–º–∞:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          Telegram Bot (main.py)                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚îÇ /start –∏–ª–∏ /app –∫–æ–º–∞–Ω–¥–∞
                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    telegram_bot.py (—Å—Ç—Ä–æ–∫–∞ 1052)                   ‚îÇ
‚îÇ    await smart_notifications.start()               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    smart_notifications.py (—Å—Ç—Ä–æ–∫–∞ 172)             ‚îÇ
‚îÇ    self.enabled = True                             ‚îÇ
‚îÇ    self._queue_task = asyncio.create_task(...)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚îÇ –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ –æ—á–µ—Ä–µ–¥—å
                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    _process_queue() (—Å—Ç—Ä–æ–∫–∞ 300+)                  ‚îÇ
‚îÇ    if message.needs_ai:                            ‚îÇ
‚îÇ        await haiku_explainer.explain()             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    haiku_explainer.py (—Å—Ç—Ä–æ–∫–∞ 148)                 ‚îÇ
‚îÇ    async def explain():                            ‚îÇ
‚îÇ        await self._call_api()                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ
                ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ    _call_api() (—Å—Ç—Ä–æ–∫–∞ 200+)                       ‚îÇ
‚îÇ    POST https://openrouter.ai/api/v1/...           ‚îÇ
‚îÇ    MODEL = "anthropic/claude-3-haiku-20240307"     ‚îÇ
‚îÇ    ‚ùå 400 Error: Invalid model ID                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:

1. **Smart Notifications** ‚Üí –î–æ–±–∞–≤–ª—è–µ—Ç AI –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º
2. **–¢–∏–ø—ã –æ–±—ä—è—Å–Ω–µ–Ω–∏–π:**
   - `news` ‚Äî –ê–Ω–∞–ª–∏–∑ –Ω–æ–≤–æ—Å—Ç–µ–π
   - `signal` ‚Äî –ü–æ—á–µ–º—É –ø–æ—è–≤–∏–ª—Å—è —Å–∏–≥–Ω–∞–ª
   - `no_signal` ‚Äî –ü–æ—á–µ–º—É –Ω–µ—Ç —Å–∏–≥–Ω–∞–ª–∞
   - `listing` ‚Äî –û—Ü–µ–Ω–∫–∞ –Ω–æ–≤–æ–≥–æ –ª–∏—Å—Ç–∏–Ω–≥–∞
   - `whale` ‚Äî –ê–Ω–∞–ª–∏–∑ –¥–≤–∏–∂–µ–Ω–∏–π –∫–∏—Ç–æ–≤
   - `market_status` ‚Äî –û–±–∑–æ—Ä —Ä—ã–Ω–∫–∞
   - `funding` ‚Äî –û–±—ä—è—Å–Ω–µ–Ω–∏–µ Funding Rate

3. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:** 1 —á–∞—Å TTL, –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –ø–æ—Ö–æ–∂–∏–µ –∑–∞–ø—Ä–æ—Å—ã
4. **Rate Limiting:** Max 60 –∑–∞–ø—Ä–æ—Å–æ–≤/—á–∞—Å (~$0.02/—á–∞—Å)

---

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### Rate Limiting
```python
# app/intelligence/haiku_explainer.py, —Å—Ç—Ä–æ–∫–∏ 98-100
self.requests_this_hour = 0
self.hour_start = datetime.now()
self.max_requests_per_hour = 60  # ~$0.02/—á–∞—Å –º–∞–∫—Å–∏–º—É–º
```

### –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
```python
# –°—Ç—Ä–æ–∫–∏ 94-95
self.cache: Dict[str, tuple] = {}  # key -> (response, timestamp)
self.cache_ttl = timedelta(hours=1)
```

### –≠–∫–æ–Ω–æ–º–∏—è:
- **–ë–µ–∑ –∫—ç—à–∞:** 60 –∑–∞–ø—Ä–æ—Å–æ–≤/—á–∞—Å * 24 = 1440 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å = ~$0.72/–¥–µ–Ω—å
- **–° –∫—ç—à–µ–º (50% hit rate):** ~$0.36/–¥–µ–Ω—å
- **–ú–µ—Å—è—Ü:** ~$10.80 (–±–µ–∑ –∫—ç—à–∞) –∏–ª–∏ ~$5.40 (—Å –∫—ç—à–µ–º)

**–¢–µ–∫—É—â–∏–π —Ä–∞—Å—Ö–æ–¥:** $0 (–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –º–æ–¥–µ–ª–∏)

---

## üîß –õ–æ–≥-—Ñ–∞–π–ª—ã

### –î–æ—Å—Ç—É–ø–Ω—ã–µ –ª–æ–≥–∏:
```bash
/var/log/crypto-bot.out.log       1.95 MB  # –ì–ª–∞–≤–Ω—ã–π –ª–æ–≥ (INFO)
/var/log/crypto-bot.err.log       16 KB    # –û—à–∏–±–∫–∏
/var/log/crypto-api.err.log       10 MB    # API –æ—à–∏–±–∫–∏
/var/log/crypto-bot.log          559 KB    # –û–±—â–∏–π –ª–æ–≥
```

### –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏ Haiku (–∏–∑ crypto-bot.out.log):
```
[2026-01-28 01:06:40] ERROR Haiku API error: 400 - Invalid model ID
[2026-01-28 01:08:10] ERROR Haiku API error: 400 - Invalid model ID
[2026-01-28 01:09:41] ERROR Haiku API error: 400 - Invalid model ID
[2026-01-28 01:11:11] ERROR Haiku API error: 400 - Invalid model ID
[2026-01-28 01:11:17] INFO  SmartNotifications stopped
```

**–ß–∞—Å—Ç–æ—Ç–∞:** ~1.5 –º–∏–Ω—É—Ç—ã –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ (–ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∞–ª–∏—Å—å –¥–æ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏)

---

## üéØ –†–µ–∑—é–º–µ –ø—Ä–æ–±–ª–µ–º

### üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (–ë–õ–û–ö–ò–†–£–Æ–¢ —Ä–∞–±–æ—Ç—É):
1. **–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π ID –º–æ–¥–µ–ª–∏** ‚Äî `anthropic/claude-3-haiku-20240307` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ OpenRouter
   - **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞ `anthropic/claude-3.5-haiku`
   - **–§–∞–π–ª:** `app/intelligence/haiku_explainer.py:34`
   - **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ú–ê–ö–°–ò–ú–ê–õ–¨–ù–´–ô

### üü° –í–∞–∂–Ω—ã–µ (–í–ª–∏—è—é—Ç –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ):
2. **Smart Notifications –≤—ã–∫–ª—é—á–µ–Ω—ã** ‚Äî –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `start()` –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ
   - **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –í—ã–∑–≤–∞—Ç—å `await smart_notifications.start()` –≤ `app/main.py`
   - **–§–∞–π–ª:** `app/main.py` (–¥–æ–±–∞–≤–∏—Ç—å)
   - **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í–´–°–û–ö–ò–ô

### üü¢ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ (–í—Å—ë –û–ö):
3. ‚úÖ API –∫–ª—é—á –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏ –≤–∞–ª–∏–¥–µ–Ω
4. ‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
5. ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ rate limiting —Ä–∞–±–æ—Ç–∞—é—Ç
6. ‚úÖ –ú–æ–¥—É–ª—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

---

## üõ†Ô∏è –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å)

### –®–∞–≥ 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å ID –º–æ–¥–µ–ª–∏ (5 —Å–µ–∫—É–Ω–¥)
```python
# app/intelligence/haiku_explainer.py:34
MODEL = "anthropic/claude-3.5-haiku"  # –ë—ã–ª–æ: claude-3-haiku-20240307
```

### –®–∞–≥ 2: –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å Smart Notifications (1 –º–∏–Ω—É—Ç–∞)
```python
# app/main.py (–¥–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–æ—Ç–∞)
from app.core.smart_notifications import smart_notifications

async def main():
    ...
    # –ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ Monitor
    await smart_notifications.start()
    logger.info("‚úÖ Smart Notifications enabled")
```

### –®–∞–≥ 3: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å callback –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (2 –º–∏–Ω—É—Ç—ã)
```python
# app/notifications/telegram_bot.py (–µ—Å–ª–∏ –µ—â—ë –Ω–µ—Ç)
# –í –º–µ—Ç–æ–¥–µ startup –∏–ª–∏ init
smart_notifications.set_send_callback(self.send_message)
```

### –®–∞–≥ 4: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞ (10 —Å–µ–∫—É–Ω–¥)
```bash
systemctl restart crypto-bot
```

### –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ (30 —Å–µ–∫—É–Ω–¥)
```bash
tail -f /var/log/crypto-bot.out.log | grep -i "haiku\|smart"
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ HaikuExplainer initialized
‚úÖ Smart Notifications started
‚úÖ AI explanation: 150 chars
```

---

## üí∞ –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –¢–∞—Ä–∏—Ñ—ã Claude 3.5 Haiku:
- **Input:** $0.25 / 1M tokens
- **Output:** $1.25 / 1M tokens

### –¢–∏–ø–∏—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å:
- **–ü—Ä–æ–º–ø—Ç:** ~150 tokens (—Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç + –¥–∞–Ω–Ω—ã–µ)
- **–û—Ç–≤–µ—Ç:** ~100 tokens (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
- **–°—Ç–æ–∏–º–æ—Å—Ç—å:** $0.000163 (~0.016 —Ü–µ–Ω—Ç–∞)

### –ü—Ä–æ–≥–Ω–æ–∑ —Ä–∞—Å—Ö–æ–¥–æ–≤:
```
60 –∑–∞–ø—Ä–æ—Å–æ–≤/—á–∞—Å (–ª–∏–º–∏—Ç) * 24 = 1440 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å

–° –∫—ç—à–µ–º (50% hit rate):
720 —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å * $0.000163 = $0.12/–¥–µ–Ω—å
$0.12 * 30 = $3.60/–º–µ—Å—è—Ü

–ë–µ–∑ –∫—ç—à–∞:
1440 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å * $0.000163 = $0.23/–¥–µ–Ω—å
$0.23 * 30 = $6.90/–º–µ—Å—è—Ü
```

**–ò—Ç–æ–≥–æ:** ~$3.60-6.90/–º–µ—Å—è—Ü (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç cache hit rate)

---

## üìù –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–¥—É–ª—è
```bash
cd /root/crypto-bot
python3 -c "
from app.intelligence.haiku_explainer import haiku_explainer
print('Enabled:', haiku_explainer.enabled)
print('Model:', haiku_explainer.MODEL)
"
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
Enabled: True
Model: anthropic/claude-3.5-haiku
```

### –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ API
```python
import asyncio
from app.intelligence.haiku_explainer import haiku_explainer, ExplainRequest

async def test():
    req = ExplainRequest(
        type='signal',
        data={'symbol': 'BTC', 'direction': 'LONG', 'rsi': 28}
    )
    explanation = await haiku_explainer.explain(req)
    print(f'‚úÖ Got: {explanation}')

asyncio.run(test())
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
‚úÖ Got: –°–µ–π—á–∞—Å BTC –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∑–æ–Ω–µ –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏ (RSI 28), —á—Ç–æ —á–∞—Å—Ç–æ
–ø—Ä–µ–¥—à–µ—Å—Ç–≤—É–µ—Ç –æ—Ç—Å–∫–æ–∫—É. –û–¥–Ω–∞–∫–æ —Å—Ç–æ–∏—Ç –ø–æ–º–Ω–∏—Ç—å –æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Å–Ω–∏–∂–µ–Ω–∏—è
–≤ —Å–∏–ª—å–Ω–æ–º –º–µ–¥–≤–µ–∂—å–µ–º —Ç—Ä–µ–Ω–¥–µ. –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Å–∏–≥–Ω–∞–ª–µ –æ–∫–æ–ª–æ 65%.
```

### –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ Smart Notifications
```bash
tail -f /var/log/crypto-bot.out.log | grep "SmartNotifications\|Haiku"
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
[INFO] üì¢ SmartNotifications started
[INFO] üß† Processing AI explanation for signal
[INFO] üß† Haiku response: 145 tokens
```

---

## üö® –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### 1. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å API –∫–ª—é—á–∞
‚úÖ API –∫–ª—é—á —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `.env` (–Ω–µ –≤ –∫–æ–¥–µ)  
‚úÖ –§–∞–π–ª `.env` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ `.gitignore`  
‚ö†Ô∏è –ö–ª—é—á –≤–∏–¥–µ–Ω –≤ –ª–æ–≥–∞—Ö –ø—Ä–∏ grep ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ, –Ω–æ –±—É–¥—å –æ—Å—Ç–æ—Ä–æ–∂–µ–Ω

### 2. Rate Limiting
- –ñ—ë—Å—Ç–∫–∏–π –ª–∏–º–∏—Ç: 60 –∑–∞–ø—Ä–æ—Å–æ–≤/—á–∞—Å
- –ü—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ ‚Äî –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å—Å—è
- –õ–æ–≥: `‚ö†Ô∏è Haiku rate limit reached`

### 3. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ü–æ—Ö–æ–∂–∏–µ –Ω–æ–≤–æ—Å—Ç–∏ ‚Äî –∫—ç—à–∏—Ä—É—é—Ç—Å—è 1 —á–∞—Å
- –°–∏–≥–Ω–∞–ª—ã –ø–æ –æ–¥–Ω–æ–º—É —Å–∏–º–≤–æ–ª—É ‚Äî –∫—ç—à–∏—Ä—É—é—Ç—Å—è (–æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ RSI)
- –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ 1 —á–∞—Å

### 4. Fallback
–ï—Å–ª–∏ Haiku –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:
```python
# –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ë–ï–ó AI –æ–±—ä—è—Å–Ω–µ–Ω–∏—è
# –ë–æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ
```

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [x] –ú–æ–¥—É–ª—å `haiku_explainer.py` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- [x] –ú–æ–¥—É–ª—å `smart_notifications.py` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- [x] OpenRouter API key –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ `.env`
- [ ] **ID –º–æ–¥–µ–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ `anthropic/claude-3.5-haiku`**
- [ ] **`smart_notifications.start()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ `main.py`**
- [ ] **Callback –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω**
- [ ] **–ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω**
- [ ] **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ (–ª–æ–≥–∏ —á–∏—Å—Ç—ã–µ)**

---

**–°—Ç–∞—Ç—É—Å:** ‚ùå **–ù–ï –†–ê–ë–û–¢–ê–ï–¢** (2 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã)  
**–í—Ä–µ–º—è –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** ~5 –º–∏–Ω—É—Ç  
**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–∞—Å—Ö–æ–¥ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** ~$4-7/–º–µ—Å—è—Ü  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ **–í–´–°–û–ö–ò–ô** (—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª AI –æ–±—ä—è—Å–Ω–µ–Ω–∏–π –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–µ–Ω)

---

**–§–∞–π–ª —Å–æ–∑–¥–∞–Ω:** 2026-01-28  
**–ê–≤—Ç–æ—Ä:** CryptoDen Bot Diagnostic System
